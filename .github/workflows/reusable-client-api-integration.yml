name: Reusable - Client API Integration

on:
  workflow_call:
    inputs:
      client_runtime:
        description: 'Client toolchain to use: node or python'
        required: false
        type: string
        default: node
      server_repository:
        description: 'Repo containing docker-compose.yml for the API'
        required: false
        type: string
        default: blecx/AI-Agent-Framework
      server_ref:
        description: 'Git ref (branch/tag/sha) of the server repository'
        required: false
        type: string
        default: main
      api_health_url:
        description: 'Health endpoint to wait for'
        required: false
        type: string
        default: http://localhost:8000/health
      api_base_url:
        description: 'Base URL exposed to client tests'
        required: false
        type: string
        default: http://localhost:8000
      client_workdir:
        description: 'Working directory in the client repo (e.g. apps/web)'
        required: false
        type: string
        default: .
      node_version:
        description: 'Node version for client checks'
        required: false
        type: string
        default: '20'
      client_install_command:
        description: 'Install command for the client repo (Node)'
        required: false
        type: string
        default: npm ci
      client_lint_command:
        description: 'Lint command for the client repo (Node). Empty = skip'
        required: false
        type: string
        default: ''
      client_build_command:
        description: 'Build command for the client repo (Node). Empty = skip'
        required: false
        type: string
        default: ''
      python_version:
        description: 'Python version for client tests'
        required: false
        type: string
        default: '3.12'
      client_test_command:
        description: 'Command to execute client repo tests (runs in client_workdir)'
        required: true
        type: string

jobs:
  client-api-integration:
    runs-on: ubuntu-latest

    steps:
      # Caller repo (e.g., AI-Agent-Framework-Client)
      - name: Checkout client repository
        uses: actions/checkout@v4

      # Server repo (this backend)
      - name: Checkout server repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.server_repository }}
          ref: ${{ inputs.server_ref }}
          path: server

      - name: Start API via docker compose
        shell: bash
        run: |
          set -euo pipefail
          # Create bind mount directory for projectDocs
          mkdir -p server/projectDocs
          
          # Override docker-compose to use bind mount instead of named volume
          # This ensures projectDocs exists and is accessible
          cat > server/docker-compose.override.yml <<EOF
          version: '3.8'
          services:
            api:
              volumes:
                # Use bind mount for CI (overrides named volume)
                - ./projectDocs:/projectDocs
          EOF
          
          # Start API with override
          cd server
          docker compose up -d --build api
          cd ..
          
          echo "API container started, waiting for initialization..."
          sleep 5

      - name: Wait for API health
        shell: bash
        run: |
          set -euo pipefail
          url="${{ inputs.api_health_url }}"
          echo "Waiting for API health check: $url"
          echo "Timeout: 120 seconds (60 retries x 2s)"
          
          for i in {1..60}; do
            echo -n "Attempt $i/60... "
            if response=$(curl -fsS "$url" 2>&1); then
              echo "✓ API is healthy!"
              echo "Response: $response"
              exit 0
            fi
            echo "✗ Not ready yet"
            sleep 2
          done
          
          echo ""
          echo "═══════════════════════════════════════════════════════════"
          echo "API HEALTH CHECK FAILED"
          echo "═══════════════════════════════════════════════════════════"
          echo ""
          echo "API did not become healthy within 120 seconds."
          echo ""
          echo "Container status:"
          cd server && docker compose ps && cd ..
          echo ""
          echo "API logs (last 200 lines):"
          cd server && docker compose logs --no-color --tail=200 api && cd ..
          echo ""
          echo "═══════════════════════════════════════════════════════════"
          exit 1

      - name: Set up Node
        if: ${{ inputs.client_runtime == 'node' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: npm
          cache-dependency-path: ${{ inputs.client_workdir }}/package-lock.json

      - name: Install client dependencies (Node)
        if: ${{ inputs.client_runtime == 'node' }}
        working-directory: ${{ inputs.client_workdir }}
        shell: bash
        run: |
          set -euo pipefail
          ${{ inputs.client_install_command }}

      - name: Lint client (Node)
        if: ${{ inputs.client_runtime == 'node' && inputs.client_lint_command != '' }}
        working-directory: ${{ inputs.client_workdir }}
        shell: bash
        run: |
          set -euo pipefail
          ${{ inputs.client_lint_command }}

      - name: Build client (Node)
        if: ${{ inputs.client_runtime == 'node' && inputs.client_build_command != '' }}
        working-directory: ${{ inputs.client_workdir }}
        shell: bash
        run: |
          set -euo pipefail
          ${{ inputs.client_build_command }}

      - name: Set up Python
        if: ${{ inputs.client_runtime == 'python' }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install client dependencies (Python)
        if: ${{ inputs.client_runtime == 'python' }}
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run client tests against API
        shell: bash
        working-directory: ${{ inputs.client_workdir }}
        env:
          API_BASE_URL: ${{ inputs.api_base_url }}
        run: |
          set -euo pipefail
          ${{ inputs.client_test_command }}

      - name: Teardown
        if: always()
        shell: bash
        run: |
          cd server
          docker compose down -v
          cd ..
          # Clean up override file
          rm -f server/docker-compose.override.yml
