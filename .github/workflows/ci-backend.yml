name: Backend CI Quality Gates

on:
  pull_request:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'apps/tui/**'
      - 'tests/**'
      - 'requirements.txt'
      - 'apps/api/requirements.txt'
      - '.github/workflows/ci-backend.yml'
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'apps/tui/**'
      - 'tests/**'

concurrency:
  group: backend-ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Gate 1: All Tests Pass
  test:
    name: "Gate 1: All Tests Pass"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      duration_seconds: ${{ steps.test-timing.outputs.duration_seconds }}
      within_limit: ${{ steps.test-timing.outputs.within_limit }}
    env:
      PYTHONPATH: ${{ github.workspace }}/apps/api:${{ github.workspace }}/apps/tui:${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create projectDocs directory
        run: mkdir -p projectDocs

      - name: Configure git identity (required for git-backed tests)
        run: |
          git config --global user.email "ci@example.com"
          git config --global user.name "CI"
      
      - name: Run tests and capture duration
        id: test-timing
        env:
          TERM: xterm-256color
        run: |
          START_TIME=$(date +%s)
          
          pytest tests/unit/ -v --tb=short -m "not tui"
          pytest tests/integration/ -v --tb=short
          pytest tests/e2e/ -v --tb=short -m "not tui"

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "duration_seconds=$DURATION" >> "$GITHUB_OUTPUT"

          if [ $DURATION -gt 600 ]; then
            echo "within_limit=false" >> "$GITHUB_OUTPUT"
          else
            echo "within_limit=true" >> "$GITHUB_OUTPUT"
          fi

          echo "Gate 1 duration: ${DURATION}s"
      
      - name: Gate Status
        if: failure()
        run: |
          echo "‚ùå Gate 1 FAILED: One or more tests failed"
          echo "Remediation: Run 'pytest tests/' locally and fix failing tests"
          exit 1

  # Gate 2: Coverage Threshold
  coverage:
    name: "Gate 2: Coverage Threshold (80%+)"
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 20
    env:
      PYTHONPATH: ${{ github.workspace }}/apps/api:${{ github.workspace }}/apps/tui:${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for diff
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest-cov
      
      - name: Create projectDocs directory
        run: mkdir -p projectDocs

      - name: Configure git identity (required for git-backed tests)
        run: |
          git config --global user.email "ci@example.com"
          git config --global user.name "CI"
      
      - name: Run tests with coverage
        run: |
          bash scripts/run_pytest_coverage.sh --local-stable
      
      - name: Check coverage diff
        run: |
          python scripts/coverage_diff.py origin/main HEAD
      
      - name: Gate Status
        if: failure()
        run: |
          echo "‚ùå Gate 2 FAILED: Coverage below 80% for changed files"
          echo "Remediation: Add tests for new/changed code to reach 80%+ coverage"
          exit 1

  # Gate 3: Missing Tests Detection
  missing-tests:
    name: "Gate 3: Missing Tests Detection"
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Check for missing test files
        run: |
          # Get *new* Python files added in apps/.
          #
          # Note: This gate is meant to prevent adding new modules without tests.
          # It should not fail for edits to existing modules (e.g., formatting or refactors)
          # where tests may already exist but not follow a 1:1 mirrored file-path convention.
          CHANGED_FILES=$(git diff --name-only --diff-filter=A origin/main...HEAD | grep '^apps/.*\.py$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "‚úÖ No new Python files added in apps/"
            exit 0
          fi
          
          MISSING_TESTS=""
          for file in $CHANGED_FILES; do
            # Skip __init__.py files
            if [[ "$file" == *"__init__.py" ]]; then
              continue
            fi
            
            # Derive expected test file path
            if [[ "$file" == apps/api/* ]]; then
              module_path="${file#apps/api/}"
              test_file="tests/unit/test_${module_path}"
            elif [[ "$file" == apps/tui/* ]]; then
              module_path="${file#apps/tui/}"
              test_file="tests/unit/test_${module_path}"
            else
              continue
            fi
            
            # Check if test file exists
            if [ ! -f "$test_file" ]; then
              MISSING_TESTS="$MISSING_TESTS\n  - $file (expected: $test_file)"
            fi
          done
          
          if [ -n "$MISSING_TESTS" ]; then
            echo "‚ùå Gate 3 FAILED: New code added without tests"
            echo "Missing test files:"
            echo -e "$MISSING_TESTS"
            echo ""
            echo "Remediation: Create test files for the above modules"
            exit 1
          fi
          
          echo "‚úÖ All new/changed code has corresponding test files"

  # Gate 4: Documentation Sync
  docs-sync:
    name: "Gate 4: Documentation Sync"
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Check tests/README.md sync
        run: |
          python scripts/check_test_docs.py
      
      - name: Gate Status
        if: failure()
        run: |
          echo "‚ùå Gate 4 FAILED: tests/README.md out of sync with test structure"
          echo "Remediation: Update tests/README.md to reflect current test organization"
          exit 1

  # Gate 5: OpenAPI Spec Validation
  openapi:
    name: "Gate 5: OpenAPI Spec Validation"
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r apps/api/requirements.txt
      
      - name: Create projectDocs directory
        run: mkdir -p projectDocs
      
      - name: Generate OpenAPI spec
        run: |
          cd apps/api
          python -c "
          import sys
          sys.path.insert(0, '.')
          from main import app
          import json
          spec = app.openapi()
          print(json.dumps(spec, indent=2))
          " > openapi.json
      
      - name: Validate OpenAPI spec
        run: |
          cd apps/api
          python -c "
          import json
          with open('openapi.json') as f:
              spec = json.load(f)
          
          # Check for required fields
          assert 'openapi' in spec, 'Missing openapi version'
          assert 'info' in spec, 'Missing info section'
          assert 'paths' in spec, 'Missing paths section'
          
          # Check all endpoints have descriptions
          missing_desc = []
          for path, methods in spec['paths'].items():
              for method, details in methods.items():
                  if 'summary' not in details and 'description' not in details:
                      missing_desc.append(f'{method.upper()} {path}')
          
          if missing_desc:
              print('‚ùå Endpoints missing descriptions:')
              for endpoint in missing_desc:
                  print(f'  - {endpoint}')
              exit(1)
          
          print(f'‚úÖ OpenAPI spec valid ({len(spec[\"paths\"])} endpoints documented)')
          "
      
      - name: Gate Status
        if: failure()
        run: |
          echo "‚ùå Gate 5 FAILED: OpenAPI spec incomplete or invalid"
          echo "Remediation: Add docstrings/descriptions to all API endpoints"
          exit 1

  # Gate 6: Linting
  lint:
    name: "Gate 6: Linting (black + flake8)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          # Keep the toolchain pinned to the repo's declared versions for determinism.
          pip install black==24.1.1 flake8==7.0.0
      
      - name: Run Gate 6 lint checks
        env:
          CI_DIFF_ONLY: true
          CI_DIFF_RANGE: ${{ github.event_name == 'pull_request' && 'origin/main...HEAD' || 'HEAD~1...HEAD' }}
        run: |
          bash scripts/quality/gate6_lint.sh
      
      - name: Gate Status
        if: failure()
        run: |
          echo "‚ùå Gate 6 FAILED: Code style violations detected"
          echo "Remediation: Run 'python -m black apps/api/ apps/tui/ tests/' to auto-format"
          echo "             Then run 'python -m flake8 apps/api/' to check for remaining issues"
          exit 1

  # Gate 7: Security Scanning
  security:
    name: "Gate 7: Security Scanning (bandit + safety)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
      
        - name: Run Gate 7 security checks
        env:
            CI_DIFF_ONLY: true
            CI_DIFF_RANGE: ${{ github.event_name == 'pull_request' && 'origin/main...HEAD' || 'HEAD~1...HEAD' }}
        run: |
          bash scripts/quality/gate7_security.sh
      
      - name: Gate Status
        if: failure()
        run: |
          echo "‚ùå Gate 7 FAILED: Security vulnerabilities detected"
          echo "Remediation: Review and fix security issues, or add to whitelist if false positive"
          exit 1

  # Gate 8: Test Execution Time
  test-time:
    name: "Gate 8: Test Execution Time (<10min)"
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Evaluate timing from Gate 1
        run: |
          DURATION='${{ needs.test.outputs.duration_seconds }}'
          WITHIN_LIMIT='${{ needs.test.outputs.within_limit }}'
          
          echo "Gate 1 test duration: ${DURATION}s"
          
          if [ "$WITHIN_LIMIT" != "true" ]; then
            echo "‚ùå Gate 8 FAILED: Test suite took ${DURATION}s (limit: 600s / 10min)"
            echo "Remediation: Optimize slow tests or parallelize execution"
            exit 1
          fi
          
          echo "‚úÖ Test suite within time limit (${DURATION}s / 600s)"

  # Gate 9: Flaky Test Detection
  flaky-tests:
    name: "Gate 9: Flaky Test Detection"
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 10
    env:
      PYTHONPATH: ${{ github.workspace }}/apps/api:${{ github.workspace }}/apps/tui:${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create projectDocs directory
        run: mkdir -p projectDocs

      - name: Configure git identity (required for git-backed tests)
        run: |
          git config --global user.email "ci@example.com"
          git config --global user.name "CI"
      
      - name: Run targeted tests twice to detect flakiness
        run: |
          echo "Running targeted suite twice to detect flaky tests quickly..."
          TARGETS="tests/unit tests/integration"
          
          # Run 1
          pytest $TARGETS -v --tb=short -q -m "not tui" > run1.log 2>&1
          RUN1=$?
          
          # Run 2
          pytest $TARGETS -v --tb=short -q -m "not tui" > run2.log 2>&1
          RUN2=$?
          
          # Check for inconsistent results
          if [ $RUN1 -ne $RUN2 ]; then
            echo "‚ùå Gate 9 WARNING: Flaky tests detected (inconsistent results across runs)"
            echo "Run 1 exit code: $RUN1"
            echo "Run 2 exit code: $RUN2"
            echo ""
            echo "‚ö†Ô∏è  This is a warning only - not failing the build"
            echo "Remediation: Investigate and fix non-deterministic test behavior"
          else
            echo "‚úÖ No flaky tests detected (2 consistent runs)"
          fi

  # Final gate: All gates passed
  all-gates-passed:
    name: "‚úÖ All CI Gates Passed"
    runs-on: ubuntu-latest
    needs: [test, coverage, missing-tests, docs-sync, openapi, lint, security, test-time, flaky-tests]
    steps:
      - name: Success
        run: |
          echo "üéâ All 9 CI quality gates passed!"
          echo "‚úÖ Gate 1: All tests pass"
          echo "‚úÖ Gate 2: Coverage threshold (80%+)"
          echo "‚úÖ Gate 3: Missing tests detection"
          echo "‚úÖ Gate 4: Documentation sync"
          echo "‚úÖ Gate 5: OpenAPI spec validation"
          echo "‚úÖ Gate 6: Linting (black + flake8)"
          echo "‚úÖ Gate 7: Security scanning (bandit + safety)"
          echo "‚úÖ Gate 8: Test execution time (<10min)"
          echo "‚úÖ Gate 9: Flaky test detection"
          echo ""
          echo "PR is ready to merge! üöÄ"
